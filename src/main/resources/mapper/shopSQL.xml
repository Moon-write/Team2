<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="shop">
 	 <select id="selectShopInfo" parameterType="int" resultType="s">
		select distinct
		    biz_name as shopName, 
		    biz_no as bizNo,
		    shop_no as shopNo,
		    nvl(shop_intro,' ') as shopIntro,
		    nvl(shop_birth,' ') as shopBirth,
		    nvl((select sum(order_price) from order_tbl where seller_no=#{memberNo}),0) as grossIncome
		    from shop s 
		    left join member m on (m.member_no=s.member_no)
		    left join order_tbl o on(seller_no=m.member_no)
	    where m.member_no=#{memberNo}
	</select>
	
	<select id="selectCategory" parameterType="int" resultType="sc">
		select shop_category_no as shopCategoryNo, nvl(category,'없음') as category from shop_category where shop_no=#{shopNo} order by shop_category_no
	</select>	
	
	<select id="selectShopPic" parameterType="int" resultType="sp">
		select shop_no as shopNo, shop_filename as shopFilename, shop_filepath as shopFilepath from shop_pic where shop_no=#{shopNo}
	</select>
	<select id="selectShopPicList" parameterType="int" resultType="sp">
		select 
			shop_pic_no as shopPicNo, s.shop_no as shopNo, shop_filename as shopFilename, shop_filepath as shopFilepath 
			from shop s 
			join shop_pic sp on (s.shop_no=sp.shop_no) 
		where member_no=#{memberNo}
	</select>
	<insert id="insertFile" parameterType="sp">
		declare 
			pic_count number;
			too_many_num_exception exception;
		begin
			select count(shop_no) 
			into pic_count 
			from shop_pic where shop_no = #{shopNo};
		if(pic_count = 4)
		Then
		    raise too_many_num_exception;
		end if;
		
			insert into shop_pic
			values(shop_pic_seq.nextval,#{shopNo},#{shopFilename},#{shopFilepath});
		exception
		    when too_many_num_exception then
		         null;  
		end;
	</insert>
	
	<select id="selectDelPic" parameterType="int" resultType="sp">
		select 
			shop_filepath as shopFilepath from shop_pic 
		where shop_pic_no=#{shopPicNo}
	</select>
	
	<delete id="deleteShopPic" parameterType="int">
		delete from shop_pic where shop_pic_no=#{shopPicNo}
	</delete>
	
	<insert id="insertShopIntro" parameterType="map">
		update shop set shop_intro=#{shopIntro} where shop_no=#{shopNo}
	</insert>
	
	<delete id="deleteCategory" parameterType="int">
		delete from shop_category where shop_category_no=#{shopCategoryNo}
	</delete>
	<insert id="insertCategory" parameterType="map">
		insert into shop_category values(shop_category_seq.nextval,#{shopNo},#{category})
	</insert>
</mapper>
